<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.facishare.pay.bill.dao.impl.BillResultDetailDaoImpl">
    
    <resultMap id="BaseResultMap" type="billResultDetailDo">
        <id property="id" column="id" />
        <result property="enterpriseAccount" column="enterprise_account" />
        <result property="fsUserId" column="fs_user_id" />
        <result property="balance" column="balance" />
        <result property="status" column="status" />
        <result property="updateTime" column="update_time" />
    </resultMap>
    
    <sql id="All_Column">
        id,
        enterprise_account,
        fs_user_id,
        balance,
        status,
        update_time
    </sql>

    <!-- 添加对账记录 -->
    <insert id="addBillResultDetail" parameterType="billResultDetailDo" >
        INSERT INTO bill_result_detail(enterprise_account, fs_user_id, balance, status, update_time)
        VALUES (
                #{enterpriseAccount},
                #{fsUserId},
                #{balance},
                #{status},
                #{updateTime,jdbcType=DATE}
            )
    </insert>
    
    <!-- 查询对账记录 -->
    <select id="queryBillResultDetail" parameterType="map" resultMap="BaseResultMap">
        SELECT 
            <include refid="All_Column"></include>
        FROM 
            bill_result_detail detail
        WHERE
            detail.enterprise_account = #{enterpriseAccount}
            AND detail.fs_user_id = #{fsUserId}
    </select>
    
    <!-- 按条件分页查询对账记录 -->
    <select id="queryBillResultDetailPage" parameterType="map" resultMap="BaseResultMap">
        SELECT 
            <include refid="All_Column"></include>
        FROM 
            bill_result_detail detail
            <include refid="resultDetailCondition"></include>
        ORDER BY 
            update_time DESC
        limit #{limit} offset #{offset}
    </select>
    
    <!-- 按条件查询对账记录 -->
    <select id="queryBillResultDetailCount" parameterType="map" resultType="long">
        SELECT 
            COUNT(*)
        FROM 
            bill_result_detail detail
            <include refid="resultDetailCondition"></include>
    </select>
	
	<update id="updateBillResultDetail" parameterType="map">
        UPDATE bill_result_detail SET balance = #{balance}, update_time = #{updateTime}
        WHERE id = #{id}
    </update>
    
    <!-- 删除对账记录 -->
    <delete id="deleteBillResultDetail" parameterType="map">
        DELETE FROM bill_result_detail 
        WHERE
        <![CDATA[ update_time < #{beginTime}
           or update_time > #{endTime} ]]>
        
    </delete>
	
	<sql id="resultDetailCondition">
        <where>
            <if test="enterpriseAccount != null">
                AND detail.enterprise_account = #{enterpriseAccount}
            </if>
            <if test="fsUserId != null">
                AND detail.fs_user_id = #{fsUserId}
            </if>
        </where>
    </sql>
</mapper>