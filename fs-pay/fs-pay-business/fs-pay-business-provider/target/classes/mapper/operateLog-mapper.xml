<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.facishare.pay.business.dao.impl.OperateLogDaoImpl">
    
    <resultMap id="BaseResultMap" type="operateLogDo">
        <id property="id" column="id" />
        <result property="orderNo" column="order_no" />
        <result property="busiNo" column="busi_no" typeHandler="com.facishare.pay.common.utils.EnumStatusHandler"/>
        <result property="operateType" column="operate_type" typeHandler="com.facishare.pay.common.utils.EnumStatusHandler"/>
        <result property="transType" column="trans_type" typeHandler="com.facishare.pay.common.utils.EnumStatusHandler"/>
        <result property="requestInfo" column="request_info" />
        <result property="createTime" column="create_time" />
    </resultMap>
    
    <sql id="All_Column">
        id,
        order_no,
        busi_no,
        operate_type,
        trans_type,
        request_info,
        create_time
    </sql>
    
    <!-- 添加操作日志 -->
    <insert id="addOperateLog" parameterType="operateLogDo">
        INSERT INTO operate_log(
            order_no,
	        busi_no,
	        operate_type,
	        trans_type,
	        request_info,
	        create_time)
        VALUES (
                #{orderNo},
                #{busiNo, typeHandler=com.facishare.pay.common.utils.EnumStatusHandler},
                #{operateType, typeHandler=com.facishare.pay.common.utils.EnumStatusHandler},
                #{transType, typeHandler=com.facishare.pay.common.utils.EnumStatusHandler},
                #{requestInfo},
                #{createTime}
            )
    </insert>
    
    <!-- 分页查询操作日志 -->
    <select id="queryOperateLogPager" parameterType="map" resultMap="BaseResultMap">
        SELECT 
        <include refid="All_Column"></include>
        FROM operate_log
        <include refid="operateLogCondition"></include>
        ORDER BY create_time DESC
        limit #{limit} offset #{offset}
    </select>
    
    <!-- 查询操作日志总数 -->
    <select id="queryOperateLogCount" parameterType="map" resultType="long">
        SELECT 
            COUNT(*)
        FROM operate_log
        <include refid="operateLogCondition"></include>
    </select>
    
    <sql id="operateLogCondition">
        <where>
            <if test="orderNo != null">
                order_no = #{orderNo}
            </if>
            <if test="busiNo != null">
                AND busi_no = #{busiNo}
            </if>
            <if test="operateType != null">
                AND operate_type = #{operateType}
            </if>
            <if test="transType != null">
                AND trans_type = #{transType}
            </if>
            <if test="createTime != null">
                <![CDATA[
                AND create_time >= #{createTime}
                ]]>                 
            </if>
            <if test="endTime != null">
                <![CDATA[
                AND create_time < #{endTime}
                ]]>
            </if>
        </where>
    </sql>
</mapper>
